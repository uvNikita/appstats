{% extends "layout.html" %}
{% block body %}
    <form>
        <span name="hours_radio" class="btn-group" data-toggle="buttons-radio" onclick="_submit()">
            <button name="hours" value="6" class="btn {{ 'active' if hours == 6 else ''}}">6 hours</button>
            <button name="hours" value="12" class="btn {{ 'active' if hours == 12 else ''}}">12 hours</button>
            <button name="hours" value="24" class="btn {{ 'active' if hours == 24 else ''}}">1 day</button>
            <button name="hours" value="144" class="btn {{ 'active' if hours == 144 else ''}}">6 days</button>
            <button name="hours" value="720" class="btn {{ 'active' if hours == 720 else ''}}">30 days</button>
        </span>
    </form>
    <h2>{{ name }}</h2>
    <div class="row">
        <div class="span5">
            <table class="table table-condensed">
                <thead>
                    <th> Count </th>
                    <th> Avg(1h) </th>
                    <th> Avg(24h) </th>
                    <th> 1h </th>
                    <th> 24h </th>
                </thead>
                <tbody>
                    {% for field in fields %}
                        <tr>
                            <td>{{ field['name'] }}</td>
                            {% if field['format'] == 'time' %}
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour_aver'), 0.0) | time }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day_aver'), 0.0) | time }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour'), 0.0) | time }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day'), 0.0) | time }} </td>
                            {% elif field['format'] == 'filesize' %}
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour_aver'), 0.0) | filesizeformat }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day_aver'), 0.0) | filesizeformat }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour'), 0.0) | filesizeformat }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day'), 0.0) | filesizeformat }} </td>
                            {% elif field['format'] == 'count' %}
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour_aver'), 0.0) | count }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day_aver'), 0.0) | count }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour'), 0.0) | count }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day'), 0.0) | count }} </td>
                            {% else %}
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour_aver'), 0.0) }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day_aver'), 0.0) }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'hour'), 0.0) }} </td>
                                <td> {{ doc.setdefault('%s_%s' % (field['key'], 'day'), 0.0) }} </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="span7">
            <div style="height: 300px;" id="num_graph"></div>
            <div style="height: 300px;" id="time_graph"></div>
        </div>
    </div>

    <script>
        function _submit() {
            hours = $('button[name="hours"].active').val();
            document.location.href="{{ url_for(request.endpoint, app_id=app_id, name=name)}}" +
            '?' + $.param([
                {name : 'hours', value : hours}
            ])
        }

        function draw_graph(table, names, container_id) {
            var chart;
            var data = []

            data.push({
                name: names[0],
                data: table[0]
            })
            for (var i=1; i < table.length; i++) {
                data.push(
                {
                    stacking: 'normal',
                    name: names[i],
                    data: table[i]
                }
                )
            }

            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });

            chart = new Highcharts.Chart({
                chart: {
                    renderTo: container_id,
                    type: 'area',
                    spacingRight: 20
                },
                title: {
                    text: null
                },
                xAxis: {
                    type: 'datetime',
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    title: {
                        text: null
                    },
                    startOnTick: false,
                    showFirstLabel: false
                },
                legend: {
                    enabled: true
                },
                plotOptions: {
                    area: {
                        fillOpacity: 1,
                        lineWidth: 1,
                        marker: {
                            enabled: false,
                        },
                        enableMouseTracking: false,
                        shadow: false,
                    },
                    series: {
                        animation: false,
                    },
                },

                series: data,
            });
            
        };

        $(document).ready(function() {
            draw_graph({{ num_data|json }}, {{ ['NUMBER / sec']|safe }}, 'num_graph');
            draw_graph({{ time_data|json }}, {{ time_labels|safe }}, 'time_graph');
        });
    </script>
    <script src="{{ url_for('static', filename='js/highcharts.js') }}"></script>
{% endblock %}
